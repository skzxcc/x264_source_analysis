## å‰è¨€

#### å˜æ¢ç¼–ç çš„åŸºæœ¬æ¦‚å¿µ

ç»å¤§å¤šæ•°å›¾åƒéƒ½æœ‰ä¸€ä¸ªå…±åŒçš„ç‰¹å¾ï¼šå¹³å¦åŒºåŸŸå’Œå†…å®¹å˜åŒ–ç¼“æ…¢çš„åŒºåŸŸå æ®ä¸€å¹…å›¾åƒçš„å¤§éƒ¨åˆ†ï¼Œè€Œç»†èŠ‚åŒºåŸŸå’Œå†…å®¹çªå˜åŒºåŸŸåˆ™å å°éƒ¨åˆ†ã€‚ä¹Ÿå¯ä»¥è¯´ï¼Œå›¾åƒä¸­ç›´æµæˆ–è€…ä½é¢‘å ç»å¤§éƒ¨åˆ†ï¼Œè€Œé«˜é¢‘åŒºå ä¸€å°éƒ¨åˆ†ã€‚ç©ºé—´åŸŸçš„å›¾åƒå˜æ¢åˆ°é¢‘åŸŸ/å˜æ¢åŸŸï¼Œä¼šäº§ç”Ÿç›¸å…³æ€§å¾ˆå°çš„ä¸€äº›å˜æ¢ç³»æ•°ï¼Œå¹¶å¯å¯¹å…¶è¿›è¡Œå‹ç¼©ç¼–ç ï¼Œå³æ‰€è°“çš„å˜æ¢ç¼–ç ã€‚

å˜æ¢ä¸­æœ‰ä¸€ç±»å«åšæ­£äº¤å˜æ¢ï¼Œå¯ç”¨äºå›¾åƒç¼–ç ã€‚è‡ª1968å¹´åˆ©ç”¨å¿«é€Ÿå‚…é‡Œå¶å˜æ¢(FFT)è¿›è¡Œå›¾åƒç¼–ç ä»¥æ¥ï¼Œå‡ºç°äº†è®¸å¤šæ­£äº¤å˜åŒ–çš„ç¼–ç æ–¹å¼ï¼Œå¦‚K-Lå˜æ¢ã€ç¦»æ•£ä½™å¼¦å˜æ¢(DCT)ç­‰ã€‚å…¶ä¸­K-Lçš„ç¼–ç æ€§èƒ½æœ€ä¸ºç†æƒ³ï¼Œä½†ç¼ºä¹å¿«é€Ÿç®—æ³•ï¼Œä¸”å˜æ¢çŸ©é˜µéšå›¾åƒè€Œå¼‚ï¼Œä¸åŒå›¾åƒéœ€è¦è®¡ç®—ä¸åŒçš„å˜æ¢çŸ©é˜µï¼Œå› è€Œåªç”¨æ¥å‚è€ƒæ¯”è¾ƒã€‚DCTç¼–ç æ€§èƒ½æœ€æ¥è¿‘K-Lå˜æ¢ï¼Œç•¥æ¬¡ä¹‹è€Œå·²ï¼Œä½†å…·æœ‰å¿«é€Ÿç®—æ³•ï¼Œå¹¿æ³›åº”ç”¨äºå›¾åƒç¼–ç ã€‚**H264ä¸­å°±æ˜¯ä½¿ç”¨DCTå˜æ¢**



#### é‡åŒ–

é‡åŒ–ä¸»è¦ç›®çš„æ—¶ä¸ºäº†è¿›ä¸€æ­¥å‹ç¼©ç ç‡ï¼Œè®©ç»è¿‡å˜æ¢ç¼–ç åçš„æ®‹å·®ç»è¿‡é‡åŒ–åçš„å€¼èƒ½å¤Ÿæ›´åŠ â€œèšé›†â€ï¼Œæœ‰åŠ©äºåç»­çš„ç†µç¼–ç 





## DCTæ•´æ•°å˜æ¢ä¸é‡åŒ–

ç”±äºæµ®ç‚¹æ•°çš„è®¡ç®—æ¯”è¾ƒå¤æ‚ï¼Œ**H264ä½¿ç”¨çš„æ˜¯DCTæ•´æ•°å˜æ¢**ï¼Œæ•´æ•°ç¼–ç æ˜¯ç‰ºç‰²å¾ˆå°çš„è´¨é‡æ¢å–æ›´å¿«çš„ç¼–ç ã€‚åœ¨å›¾åƒç¼–ç ä¸­ï¼Œå˜æ¢å’Œé‡åŒ–åœ¨åŸç†ä¸Šæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„è¿‡ç¨‹ã€‚**ä½†åœ¨H264ä¸­è¿™ä¸¤ä¸ªè¿‡ç¨‹æ˜¯å¼ºç›¸å…³çš„**ã€‚

![img](å˜æ¢é‡åŒ–.assets/å˜æ¢ç¼–ç å’Œé‡åŒ–çš„è¿‡ç¨‹.png)



### DCTæ•´æ•°å˜æ¢åŸç†æ¨å¯¼

è¿™é‡Œå°±ç›´æ¥è´´å›¾äº†ï¼Œå†…å®¹æ¥è‡ªã€Šæ–°ä¸€ä»£è§†é¢‘å‹ç¼©ç¼–ç æ ‡å‡†-H264/AVCã€‹

![](å˜æ¢é‡åŒ–.assets/DCT-1.png)





![](å˜æ¢é‡åŒ–.assets/DCT-2.png)

![](å˜æ¢é‡åŒ–.assets/DCT-3.png)

![](å˜æ¢é‡åŒ–.assets/DCT-4.png)



![](å˜æ¢é‡åŒ–.assets/DCT-5.png)



![](å˜æ¢é‡åŒ–.assets/DCT-6.png)



![](å˜æ¢é‡åŒ–.assets/DCT-7.png)

#### è¶å½¢è¿ç®—ä»‹ç»

ç»“åˆå…¬å¼(5.18)ï¼Œ**Y = CXC' âŠ— E**ï¼Œ ç”±äºâŠ— Eçš„è®¡ç®—è¢«æ”¾åˆ°é‡åŒ–ä¸­è¿›è¡Œï¼Œæ•´æ•°DCTå˜æ¢åªè¿›è¡Œå…¶ä¸­**CXCt**çš„è®¡ç®—ã€‚

è¿™é‡Œå…ˆçœ‹ä¸‹çŸ©é˜µCä¸çŸ©é˜µXçš„è¿ç®—ï¼š

![](å˜æ¢é‡åŒ–.assets/DCTè¶å½¢è¿ç®—-0.jpg)

![](å˜æ¢é‡åŒ–.assets/DCTè¶å½¢è¿ç®—-1.jpg)

**H264ä¸­çš„è¶å½¢è¿ç®—å®é™…ä¸Šå°±æ˜¯è¾ƒå°‘é‡å¤é¡¹çš„è®¡ç®—**

æœªä½¿ç”¨è¶å½¢è¿ç®—æ˜¯CXçš„ç¬¬ä¸€åˆ—å€¼P00ã€P10ã€P20ã€P30éœ€è¦ç»è¿‡**12æ¬¡åŠ å‡æ³•+4æ¬¡ä¹˜æ³•**(å…¶ä¸­ä¸1ç›¸ä¹˜ä¸ç®—åœ¨å†…)ï¼Œä½¿ç”¨è¶å½¢è¿ç®—åˆ™è®¡ç®—é‡é™ä¸º**8æ¬¡åŠ å‡æ³• + 2æ¬¡ä¹˜æ³•**



### é‡åŒ–

![](å˜æ¢é‡åŒ–.assets/é‡åŒ–-1.png)



![](å˜æ¢é‡åŒ–.assets/é‡åŒ–-2.png)



![](å˜æ¢é‡åŒ–.assets/é‡åŒ–-3.png)



![](å˜æ¢é‡åŒ–.assets/é‡åŒ–-4.png)



## æºç åˆ†æ

æœ¬ç« èŠ‚æˆ‘ä»¬å°±ç›´æ¥åˆ†æi16x16å®å—ç¼–ç ä¸­çš„å˜æ¢é‡åŒ–



#### æ•´æ•°å˜æ¢

```c++
/* æˆªå–éƒ¨åˆ†ä»£ç  */
static void mb_encode_i16x16( x264_t *h, int p, int i_qp )
{
    // ......
	// DCTå˜æ¢
    h->dctf.sub16x16_dct( dct4x4, p_src, p_dst );

    // ......
 	
    for( int i8x8 = 0; i8x8 < 4; i8x8++ )
    {
        // é‡åŒ–
        nz = h->quantf.quant_4x4x4( &dct4x4[i8x8*4], h->quant4_mf[i_quant_cat][i_qp], h->quant4_bias[i_quant_cat][i_qp] );
        if( nz )
        {
            block_cbp = 0xf;
            FOREACH_BIT( idx, i8x8*4, nz )
            {
                // Zigzagæ‰«æ
                h->zigzagf.scan_4x4( h->dct.luma4x4[16*p+idx], dct4x4[idx] );
                // åé‡åŒ–
                h->quantf.dequant_4x4( dct4x4[idx], h->dequant4_mf[i_quant_cat], i_qp );
                if( decimate_score < 6 ) decimate_score += h->quantf.decimate_score15( h->dct.luma4x4[16*p+idx] );
                h->mb.cache.non_zero_count[x264_scan8[16*p+idx]] = 1;
            }
        }
    }

    // .....
}
```



```c++
static void sub8x8_dct( dctcoef dct[4][16], pixel *pix1, pixel *pix2 )
{
    // å°†8x8åˆ†ä¸º4å—4x4ï¼Œè°ƒç”¨sub4x4_dctè¿›è¡ŒDCTå˜æ¢
    sub4x4_dct( dct[0], &pix1[0], &pix2[0] );
    sub4x4_dct( dct[1], &pix1[4], &pix2[4] );
    sub4x4_dct( dct[2], &pix1[4*FENC_STRIDE+0], &pix2[4*FDEC_STRIDE+0] );
    sub4x4_dct( dct[3], &pix1[4*FENC_STRIDE+4], &pix2[4*FDEC_STRIDE+4] );
}

static void sub16x16_dct( dctcoef dct[16][16], pixel *pix1, pixel *pix2 )
{
    // å°†16x16åˆ†ä¸º4å—8x8ï¼Œåˆ†åˆ«è°ƒç”¨sub8x8_dctè¿›è¡ŒDCTå˜æ¢
    sub8x8_dct( &dct[ 0], &pix1[0], &pix2[0] );
    sub8x8_dct( &dct[ 4], &pix1[8], &pix2[8] );
    sub8x8_dct( &dct[ 8], &pix1[8*FENC_STRIDE+0], &pix2[8*FDEC_STRIDE+0] );
    sub8x8_dct( &dct[12], &pix1[8*FENC_STRIDE+8], &pix2[8*FDEC_STRIDE+8] );
}
```



**sub4x4_dct**

```c++
/* 4x4å®å—çš„DCTå˜æ¢ */
static void sub4x4_dct( dctcoef dct[16], pixel *pix1, pixel *pix2 )
{
    dctcoef d[16];
    dctcoef tmp[16];
	// è®¡ç®—æ®‹å·®ï¼Œç»“æœä¿ç•™åˆ°d[16]ä¸­
    pixel_sub_wxh( d, 4, pix1, FENC_STRIDE, pix2, FDEC_STRIDE );
	
    /*
    	å¯¹è®¡ç®—å¾—åˆ°çš„æ®‹å·®è¿›è¡ŒDCTå˜æ¢(è¶å½¢è¿ç®—), ç»“æœä¿å­˜åˆ°dct[16]ä¸­
    	Y = CXC'
     */
	// å…ˆè®¡ç®—è®¡ç®—CXçš„å€¼ï¼Œç»“æœä¸ºP
    for( int i = 0; i < 4; i++ )
    {
        // è®¡ç®—ä¸´æ—¶å€¼
        int s03 = d[i*4+0] + d[i*4+3];  // M0
        int s12 = d[i*4+1] + d[i*4+2];  // M1
        int d03 = d[i*4+0] - d[i*4+3];  // M3
        int d12 = d[i*4+1] - d[i*4+2];  // M2
		
        tmp[0*4+i] =   s03 +   s12;  // P0i
        tmp[1*4+i] = 2*d03 +   d12;  // P1i
        tmp[2*4+i] =   s03 -   s12;  // P2i
        tmp[3*4+i] =   d03 - 2*d12;  // P3i
    }
	// å†è®¡ç®—Y = PC', åŒç†
    for( int i = 0; i < 4; i++ )
    {
        int s03 = tmp[i*4+0] + tmp[i*4+3];
        int s12 = tmp[i*4+1] + tmp[i*4+2];
        int d03 = tmp[i*4+0] - tmp[i*4+3];
        int d12 = tmp[i*4+1] - tmp[i*4+2];

        dct[i*4+0] =   s03 +   s12;
        dct[i*4+1] = 2*d03 +   d12;
        dct[i*4+2] =   s03 -   s12;
        dct[i*4+3] =   d03 - 2*d12;
    }
}
```



ç»“åˆä¸Šæ–‡çš„å…¬å¼5.18 **Y = CXC' âŠ— E**ï¼Œ  sub4x4_dctå·²ç»å°†**CXC'**æ‰§è¡Œå®Œäº†ï¼ŒDCTå˜æ¢ç¯èŠ‚å°±ç»“æŸäº†ï¼Œè€ŒçŸ©é˜µEçš„è¿ç®—ä¼šæ”¾åˆ°åç»­çš„é‡åŒ–



#### é‡åŒ–

```c++
/* 
	coefä¸ºå˜æ¢åçš„æ®‹å·®
	mfä¸ºMFçŸ©å¯¹åº”æŸä¸ªä½ç½®çš„å€¼ï¼Œä½†x264ä¸­MFå…·ä½“çš„å€¼ä¸ä¸Šæ–‡è¡¨5.9ä¸­çš„å€¼æœ‰ç‚¹ä¸å¤ªä¸€æ ·
	fä¸ºåç§»é‡ï¼Œä½†x264ä¸­få…·ä½“çš„å€¼ä¹Ÿä¸ä¸Šæ–‡æåˆ°çš„ä¸å¤ªä¸€æ ·
*/
#define QUANT_ONE( coef, mf, f ) \
{ \
    if( (coef) > 0 ) \
        (coef) = (f + (coef)) * (mf) >> 16; \
    else \
        (coef) = - ((f - (coef)) * (mf) >> 16); \
    nz |= (coef); \
}

static int quant_4x4x4( dctcoef dct[4][16], udctcoef mf[16], udctcoef bias[16] )
{
    int nza = 0;
    for( int j = 0; j < 4; j++ )
    {
        int nz = 0;
        for( int i = 0; i < 16; i++ ) // å¯¹16ä¸ªæ®‹å·®è¿›è¡Œé‡åŒ–
            QUANT_ONE( dct[j][i], mf[i], bias[i] );
        nza |= (!!nz)<<j;
    }
    return nza;
}
```



é‡åŒ–çš„å…·ä½“å®ç°ä»£ç ä¸º**å®å®šä¹‰QUANT_ONE**ï¼Œ **å¯ä»¥çœ‹å‡ºæ¥å®ƒçš„å®ç°å’Œä¸Šæ–‡æ¨å¯¼å‡ºæ¥çš„å…¬å¼5.31æœ‰ç‚¹ä¸å¤ªä¸€æ ·**

5.31çš„å…¬å¼ä¸ºï¼š

![](å˜æ¢é‡åŒ–.assets/é‡åŒ–è¿ç®—å…¬å¼.png)

è€Œx264ä»£ç å®ç°ä¸ºï¼š**Z = ( (W + f) * MF ) >> 16**; 

å…¶ä¸­Wä¸¤è€…è¡¨ç¤ºçš„éƒ½æ˜¯ä¸€æ ·éƒ½æ˜¯DCTæ•´æ•°å˜æ¢ä¹‹åçš„æ®‹å·®

è€ŒMFçš„å€¼ x264æ˜¯ä¸ (>>qbits)åšäº†ä¸ªåˆå¹¶ï¼Œå˜æˆç›´æ¥>>16ï¼Œæ‰€ä»¥X264ä¸­MFçš„å€¼æ˜¯ä¸ä¸Šé¢çš„è¡¨5.9ä¸å¤ªä¸€æ ·çš„ï¼Œfä¹Ÿæ˜¯ä¸€æ ·åšäº†ä¸ªåˆå¹¶

**MFå’Œfçš„å€¼å†x264_cqm_initä¸­èƒ½å¤Ÿç¡®å®šï¼Œå¯ä»¥ç›´æ¥å°†è¿™äº›å€¼printå‡ºæ¥å°±èƒ½æ˜ç™½äº†**ï¼Œç»“æœæ˜¯å…¬å¼5.31è®¡ç®—å‡ºæ¥çš„ä¸€æ ·

```c++
// æˆªå–éƒ¨åˆ†ä»£ç ï¼Œx264_cqm_initåœ¨åˆ›å»ºç¼–ç å™¨x264_encoder_openä¸­å°±ä¼šè¢«è°ƒç”¨
static const uint16_t quant4_scale[6][3] =
{
    /* å€¼ä¸ä¸Šè¡¨5.9çš„å¯¹åº” */
    { 13107, 8066, 5243 },
    { 11916, 7490, 4660 },
    { 10082, 6554, 4194 },
    {  9362, 5825, 3647 },
    {  8192, 5243, 3355 },
    {  7282, 4559, 2893 },
};

#define SHIFT(x,s) ((s)<=0 ? (x)<<-(s) : ((x)+(1<<((s)-1)))>>(s))
#define DIV(n,d) (((n) + ((d)>>1)) / (d))

int x264_cqm_init( x264_t *h )
{
    // ......
    for( int q = 0; q < 6; q++ )
    {
        for( int i = 0; i < 16; i++ )
        {
            int j = (i&1) + ((i>>2)&1);
            def_dequant4[q][i] = dequant4_scale[q][j];
            // ä¸è¡¨5.9çš„å€¼ä¿æŒä¸€è‡´
            def_quant4[q][i]   =   quant4_scale[q][j];
        }
        for( int i = 0; i < 64; i++ )
        {
            int j = quant8_scan[((i>>1)&12) | (i&3)];
            def_dequant8[q][i] = dequant8_scale[q][j];
            def_quant8[q][i]   =   quant8_scale[q][j];
        }
    }
    
    for( int q = 0; q < 6; q++ )
    {
        for( int i_list = 0; i_list < 4; i_list++ )
            for( int i = 0; i < 16; i++ )
            {
                /*
                	H264æ ‡å‡†æ”¯æŒéä¸€è‡´æ€§é‡åŒ–ï¼Œå³ä¸åŒä½ç½®ä¸Šçš„å˜æ¢ç³»æ•°é‡åŒ–æ­¥é•¿å¯ä»¥ä¸ä¸€æ ·
                	å¦‚æœæ²¡ä½¿ç”¨éä¸€è‡´æ€§é‡åŒ–ï¼Œsps->scaling_listä¸­çš„å€¼éƒ½æ˜¯16
                	æ‰€ä»¥quant4_mfçš„å€¼è¿˜æ˜¯ä¸è¡¨5.9çš„å€¼ä¿æŒä¸€æ ·
                */
                quant4_mf[i_list][q][i] = DIV(def_quant4[q][i] * 16, h->sps->scaling_list[i_list][i]);
            }
        for( int i_list = 0; i_list < num_8x8_lists; i_list++ )
            for( int i = 0; i < 64; i++ )
            {
                quant8_mf[i_list][q][i] = DIV(def_quant8[q][i] * 16, h->sps->scaling_list[4+i_list][i]);
            }
    }
    for( int q = 0; q <= QP_MAX_SPEC; q++ )
    {
        int j;
        for( int i_list = 0; i_list < 4; i_list++ )
            for( int i = 0; i < 16; i++ )
            {
                h->unquant4_mf[i_list][q][i] = (1ULL << (q/6 + 15 + 8)) / quant4_mf[i_list][q%6][i];
                /*
                	x264çœŸæ­£ä½¿ç”¨åˆ°çš„MFçš„å€¼ï¼Œ MF = (PF/Qstep) * 2^16
                	åœ¨é‡åŒ–æ˜¯ç›´æ¥å°†(MF >> 16)ç»“æœå°±èƒ½å¾—åˆ°å…¬å¼5.26
                 */
                h->quant4_mf[i_list][q][i] = j = SHIFT(quant4_mf[i_list][q%6][i], q/6 - 1);
                if( !j )
                {
                    min_qp_err = X264_MIN( min_qp_err, q );
                    continue;
                }
                // round to nearest, unless that would cause the deadzone to be negative
                // quant4_biasä¸ºx264ä½¿ç”¨çš„åç§»å€¼fï¼Œè¿™ä¸ªå€¼ä¸deadzoneæœ‰å…³
                h->quant4_bias[i_list][q][i] = X264_MIN( DIV(deadzone[i_list]<<10, j), (1<<15)/j );
                h->quant4_bias0[i_list][q][i] = (1<<15)/j;
                if( j > 0xffff && q > max_qp_err && (i_list == CQM_4IY || i_list == CQM_4PY) )
                    max_qp_err = q;
                if( j > 0xffff && q > max_chroma_qp_err && (i_list == CQM_4IC || i_list == CQM_4PC) )
                    max_chroma_qp_err = q;
            }
        // ......
    }
}
```







## å‚è€ƒå¼•ç”¨

ğŸ±â€ğŸã€Šæ–°ä¸€ä»£è§†é¢‘å‹ç¼©ç¼–ç æ ‡å‡† - H264/AVCã€‹

ğŸ±â€ğŸã€Šæ·±å…¥ç†è§£è§†é¢‘ç¼–è§£ç æŠ€æœ¯ -  åŸºäºH.264æ ‡å‡†åŠå‚è€ƒæ¨¡å‹ã€‹

ğŸ±â€ğŸ https://github.com/mirror/x264
